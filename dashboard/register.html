<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Daftar Akun - DompetPintarBot</title>

    <!-- Tailwind & Alpine -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link rel="icon" type="image/png" href="a76trans.png">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex items-center justify-center min-h-screen" x-data="registerAuth()" x-init="init()">

  <div class="w-full max-w-sm p-8 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl">
      <div class="text-center mb-8">
          <div class="w-16 h-16 rounded-xl overflow-hidden mx-auto mb-4 shadow-lg shadow-emerald-500/20">
              <img src="croplogobot.png" alt="Logo" class="w-full h-full object-cover">
          </div>
          <h1 class="font-bold text-xl text-white">
              Dompet<span class="text-emerald-400">Pintar</span>Bot
          </h1>
          <p class="text-xs text-slate-500 mt-1">Daftar untuk mendapatkan Trial Gratis 1 Hari.</p>
      </div>

      <form @submit.prevent="register" class="space-y-5">
          <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
              <input type="text" x-model="form.username"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition text-sm"
                  placeholder="Masukkan username..." required>
          </div>

          <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
              <input type="password" x-model="form.password"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition text-sm"
                  placeholder="••••••••" required>
          </div>

          <div>
              <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Konfirmasi Password</label>
              <input type="password" x-model="form.confirm_password"
                  class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition text-sm"
                  placeholder="••••••••" required>
          </div>

          <button type="submit"
              class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-emerald-900/20 text-sm flex justify-center items-center"
              :disabled="isLoading">
              <span x-show="!isLoading">Daftar Sekarang</span>
              <span x-show="isLoading" class="animate-pulse">Memproses...</span>
          </button>

          <div x-show="message" x-transition class="p-3 rounded-lg text-center"
               :class="messageType === 'error' ? 'bg-red-500/10 border border-red-500/20 text-red-400' : 'bg-emerald-500/10 border border-emerald-500/20 text-emerald-400'">
              <p x-text="message" class="text-xs font-medium"></p>
          </div>
      </form>

      <p class="text-center text-xs text-slate-500 mt-6">
          Sudah punya akun?
          <a href="index.html" class="text-emerald-400 hover:text-emerald-300 font-medium hover:underline">Login di sini</a>
      </p>
      <p class="text-center text-xs text-slate-400 mt-1">
          Login Superadmin?
          <a href="../superadmin/admin-login.html" class="text-emerald-400 hover:text-emerald-300 underline">klik di sini</a>
      </p>
  </div>

  <script>
    // CONFIG: Ganti sesuai URL Ngrok kamu
    const API_BASE_URL = "https://unbusily-unmoralistic-micki.ngrok-free.dev";

    function registerAuth(){
      return {
        form: { username: '', password: '', confirm_password: '' },
        isLoading: false,
        message: '',
        messageType: 'error', // 'error' atau 'success'

        init(){
          // Jika user sudah login (token ada), langsung redirect ke dashboard
          const token = localStorage.getItem('jwt_token');
          if (token) {
            window.location.href = 'index.html';
          }
        },

        async register(){
          // Reset pesan
          this.message = '';
          this.messageType = 'error';

          // Basic client-side validation
          if (!this.form.username.trim() || !this.form.password) {
            this.message = "Username dan password wajib diisi.";
            return;
          }
          if (this.form.password !== this.form.confirm_password) {
            this.message = "Password dan konfirmasi tidak cocok.";
            return;
          }

          this.isLoading = true;

          try {
            const res = await fetch(`${API_BASE_URL}/register`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
              },
              body: JSON.stringify({
                username: this.form.username.trim(),
                password: this.form.password,
                confirm_password: this.form.confirm_password
              })
            });

            const data = await res.json().catch(()=>({}));

            if (res.ok) {
              // sukses: tampilkan pesan & redirect ke login (atau langsung login bila API return token)
              this.messageType = 'success';
              this.message = data.message || "Registrasi berhasil — mengalihkan ke Login...";
              
              // jika API mengembalikan token & user, simpan (opsional)
              if (data.token) {
                localStorage.setItem('jwt_token', data.token);
                localStorage.setItem('username', data.user?.username || this.form.username);
              }

              setTimeout(() => {
                // jika ada role admin redirect ke admin, tapi biasanya baru ke login
                window.location.href = 'index.html';
              }, 1200);

            } else {
              // gagal: tampilkan error dari API atau default
              this.messageType = 'error';
              this.message = data.error || data.message || "Gagal mendaftar. Periksa kembali input.";
            }

          } catch (err) {
            console.error(err);
            this.messageType = 'error';
            this.message = "Gagal koneksi ke server Backend!";
          } finally {
            this.isLoading = false;
          }
        }
      }
    }
  </script>
</body>
</html>
